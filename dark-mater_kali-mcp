#!/usr/bin/env python3

"""
DARK MATER Kali MCP CLI Tool
Interactive command-line interface for the MCP Kali Server
"""

import os
import sys
import json
import subprocess
import time
import signal
import requests
from pathlib import Path
from datetime import datetime

# ASCII Art Banner
BANNER = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘
â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘
â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘
â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•‘
â•‘  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•    â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•‘
â•‘                                                                              â•‘
â•‘                         ðŸ”° KALI MCP SERVER ðŸ”°                               â•‘
â•‘                    Advanced Security Testing Platform                       â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    MAGENTA = '\033[95m'
    CYAN = '\033[96m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
    END = '\033[0m'

class DarkMaterCLI:
    def __init__(self):
        self.server_dir = "/opt/mcp-kali-server"
        self.config_dir = "/etc/mcp-kali"
        self.venv_python = f"{self.server_dir}/venv/bin/python"
        self.server_script = f"{self.server_dir}/kali_server.py"
        self.service_name = "mcp-kali-server"
        self.server_process = None
        
    def print_banner(self):
        """Display the DARK MATER banner"""
        print(f"{Colors.CYAN}{BANNER}{Colors.END}")
        
    def print_colored(self, text, color=Colors.WHITE, bold=False):
        """Print colored text"""
        style = f"{color}{Colors.BOLD if bold else ''}"
        print(f"{style}{text}{Colors.END}")
        
    def print_separator(self):
        """Print a separator line"""
        print(f"{Colors.BLUE}{'â•' * 80}{Colors.END}")
        
    def check_root(self):
        """Check if running as root"""
        if os.geteuid() != 0:
            self.print_colored("âŒ This tool must be run as root (use sudo)", Colors.RED, True)
            sys.exit(1)
            
    def check_installation(self):
        """Check if the server is installed"""
        if not Path(self.server_script).exists():
            self.print_colored("âŒ MCP Kali Server not found. Please run the installer first.", Colors.RED, True)
            self.print_colored(f"Expected location: {self.server_script}", Colors.YELLOW)
            sys.exit(1)
            
    def get_enrollment_info(self):
        """Get enrollment information"""
        enroll_file = f"{self.config_dir}/enroll.json"
        if Path(enroll_file).exists():
            try:
                with open(enroll_file, 'r') as f:
                    return json.load(f)
            except:
                return None
        return None
        
    def get_server_credentials(self):
        """Get server credentials if enrolled"""
        creds_file = f"{self.config_dir}/credentials.json"
        if Path(creds_file).exists():
            try:
                with open(creds_file, 'r') as f:
                    return json.load(f)
            except:
                return None
        return None
        
    def prompt_ngrok_token(self):
        """Prompt for ngrok auth token"""
        self.print_colored("\nðŸŒ Ngrok Configuration", Colors.CYAN, True)
        self.print_colored("For remote access, you can configure an ngrok tunnel", Colors.WHITE)
        self.print_colored("Get your auth token from: https://dashboard.ngrok.com/get-started/your-authtoken", Colors.YELLOW)
        
        token = input(f"\n{Colors.GREEN}Enter ngrok auth token (press Enter to skip): {Colors.END}").strip()
        
        domain = None
        if token:
            domain = input(f"{Colors.GREEN}Custom domain (optional, requires paid plan): {Colors.END}").strip()
            if not domain:
                domain = None
                
        return token, domain
        
    def start_server_process(self, ngrok_token=None, ngrok_domain=None):
        """Start the server process"""
        cmd = [self.venv_python, self.server_script, "--bind", "0.0.0.0:5000"]
        
        env = os.environ.copy()
        
        if ngrok_token:
            cmd.extend(["--ngrok", "--ngrok-authtoken", ngrok_token])
            env["NGROK_AUTHTOKEN"] = ngrok_token
            if ngrok_domain:
                cmd.extend(["--ngrok-domain", ngrok_domain])
                
        self.print_colored(f"\nðŸš€ Starting DARK MATER MCP Server...", Colors.GREEN, True)
        
        # First check if files exist
        if not Path(self.venv_python).exists():
            self.print_colored(f"âŒ Python executable not found: {self.venv_python}", Colors.RED, True)
            return False
            
        if not Path(self.server_script).exists():
            self.print_colored(f"âŒ Server script not found: {self.server_script}", Colors.RED, True)
            return False
        
        try:
            # Create log file for server output
            log_file = "/var/log/mcp-kali-server.log"
            
            # Start the server process with output to log file
            with open(log_file, 'w') as f:
                self.server_process = subprocess.Popen(
                    cmd,
                    env=env,
                    stdout=f,
                    stderr=subprocess.STDOUT,
                    universal_newlines=True,
                    start_new_session=True  # Start in new session to avoid signal issues
                )
            
            self.print_colored(f"ðŸ“ Server output logged to: {log_file}", Colors.BLUE)
            
            # Give server time to start and check if it's still running
            time.sleep(5)
            
            # Check if process is still running
            if self.server_process.poll() is None:
                # Try to connect to the server to verify it's actually working
                time.sleep(2)  # Give it a bit more time
                
                try:
                    response = requests.get("http://localhost:5000/health", timeout=3)
                    if response.status_code in [200, 401]:  # 401 is expected without API key
                        self.print_colored("âœ… Server started successfully!", Colors.GREEN, True)
                        self.print_colored("ðŸ”— Server accessible at: http://localhost:5000", Colors.CYAN)
                        return True
                    else:
                        self.print_colored(f"âš ï¸ Server responding with status {response.status_code}", Colors.YELLOW)
                        return True  # Still consider it successful
                except requests.exceptions.RequestException:
                    self.print_colored("âš ï¸ Server process running but not responding yet", Colors.YELLOW)
                    self.print_colored(f"ðŸ’¡ Check logs: tail -f {log_file}", Colors.BLUE)
                    return True  # Process is running, might just need more time
            else:
                self.print_colored("âŒ Server process exited", Colors.RED, True)
                self.print_colored(f"ðŸ“‹ Check logs for details: cat {log_file}", Colors.YELLOW)
                
                # Show last few lines of log file if it exists
                try:
                    with open(log_file, 'r') as f:
                        lines = f.readlines()
                        if lines:
                            self.print_colored("ðŸ“„ Last few log lines:", Colors.YELLOW)
                            for line in lines[-5:]:
                                self.print_colored(f"  {line.strip()}", Colors.WHITE)
                except:
                    pass
                return False
                
        except Exception as e:
            self.print_colored(f"âŒ Failed to start server: {e}", Colors.RED, True)
            self.print_colored("ðŸ’¡ Try manual startup:", Colors.BLUE)
            self.print_colored(f"   {' '.join(cmd)}", Colors.WHITE)
            return False
            
    def check_server_health(self, api_key=None):
        """Check server health"""
        try:
            headers = {}
            if api_key:
                headers["Authorization"] = f"Bearer {api_key}"
                
            response = requests.get("http://localhost:5000/health", headers=headers, timeout=5)
            if response.status_code == 200:
                return response.json()
        except:
            pass
        return None
        
    def display_server_info(self):
        """Display server information and enrollment details"""
        self.print_separator()
        self.print_colored("ðŸ“‹ Server Information", Colors.CYAN, True)
        
        # Check enrollment
        enrollment = self.get_enrollment_info()
        credentials = self.get_server_credentials()
        
        if enrollment:
            self.print_colored(f"ðŸ”‘ Server ID: {enrollment.get('id', 'Unknown')}", Colors.GREEN)
            self.print_colored(f"â° Created: {enrollment.get('created', 'Unknown')}", Colors.GREEN)
            
        if credentials:
            self.print_colored(f"âœ… Status: Enrolled", Colors.GREEN)
            self.print_colored(f"ðŸ·ï¸  Label: {credentials.get('label', 'Unknown')}", Colors.GREEN)
            self.print_colored(f"ðŸ” API Key: {credentials.get('api_key', 'Unknown')[:20]}...", Colors.GREEN)
            
            # Check server health
            health = self.check_server_health(credentials.get('api_key'))
            if health:
                self.print_colored("ðŸŸ¢ Server Status: Healthy", Colors.GREEN)
                if 'ngrok_tunnel' in health and health['ngrok_tunnel'].get('public_url'):
                    self.print_colored(f"ðŸŒ Public URL: {health['ngrok_tunnel']['public_url']}", Colors.CYAN)
            else:
                self.print_colored("ðŸ”´ Server Status: Not responding", Colors.RED)
        else:
            self.print_colored("âš ï¸  Status: Not enrolled", Colors.YELLOW)
            if enrollment:
                self.print_colored("\nðŸ“ Enrollment required:", Colors.YELLOW, True)
                self.print_colored("curl -sS -X POST http://localhost:5000/enroll \\", Colors.WHITE)
                self.print_colored("  -H \"Content-Type: application/json\" \\", Colors.WHITE)
                self.print_colored(f"  -d '{{\"id\":\"{enrollment['id']}\",\"token\":\"{enrollment['token']}\",\"label\":\"Kali-Lab-1\"}}'", Colors.WHITE)
                
        self.print_colored(f"\nðŸ”— Local URL: http://localhost:5000", Colors.CYAN)
        self.print_separator()
        
    def show_menu(self):
        """Show interactive menu"""
        while True:
            print(f"\n{Colors.CYAN}ðŸŽ›ï¸  DARK MATER Control Panel{Colors.END}")
            print(f"{Colors.WHITE}1.{Colors.END} ðŸ“Š Server Status")
            print(f"{Colors.WHITE}2.{Colors.END} ðŸ”„ Restart Server")
            print(f"{Colors.WHITE}3.{Colors.END} ðŸ“‹ View Logs")
            print(f"{Colors.WHITE}4.{Colors.END} ðŸ§ª Test Health (Detailed)")
            print(f"{Colors.WHITE}5.{Colors.END} ï¿½ Enrollment Manager")
            print(f"{Colors.WHITE}6.{Colors.END} ðŸŒ Ngrok Status")
            print(f"{Colors.WHITE}7.{Colors.END} ï¿½ðŸ“ View Artifacts")
            print(f"{Colors.WHITE}8.{Colors.END} ðŸ›‘ Stop Server")
            print(f"{Colors.WHITE}9.{Colors.END} âŒ Exit")
            
            try:
                choice = input(f"\n{Colors.GREEN}Select option (1-9): {Colors.END}").strip()
                
                if choice == "1":
                    self.display_server_info()
                elif choice == "2":
                    self.restart_server()
                elif choice == "3":
                    self.view_logs()
                elif choice == "4":
                    self.test_health_detailed()
                elif choice == "5":
                    self.enrollment_manager()
                elif choice == "6":
                    self.check_ngrok_status()
                elif choice == "7":
                    self.view_artifacts()
                elif choice == "8":
                    self.stop_server()
                    break
                elif choice == "9":
                    self.stop_server()
                    break
                else:
                    self.print_colored("âŒ Invalid choice. Please select 1-9.", Colors.RED)
                    
            except KeyboardInterrupt:
                self.print_colored("\n\nðŸ›‘ Interrupted by user", Colors.YELLOW)
                self.stop_server()
                break
                
    def restart_server(self):
        """Restart the server"""
        self.print_colored("ðŸ”„ Restarting server...", Colors.YELLOW, True)
        self.stop_server()
        time.sleep(2)
        
        # Get current configuration
        token, domain = self.prompt_ngrok_token()
        self.start_server_process(token, domain)
        
    def view_logs(self):
        """View server logs"""
        log_file = "/var/log/mcp-kali-server.log"
        
        self.print_colored("ðŸ“‹ Server Logs", Colors.CYAN, True)
        self.print_separator()
        
        if not Path(log_file).exists():
            self.print_colored("âŒ Log file not found", Colors.RED)
            return
            
        print(f"{Colors.WHITE}1.{Colors.END} ðŸ“„ Show last 50 lines")
        print(f"{Colors.WHITE}2.{Colors.END} â¯ï¸  Follow logs (live)")
        print(f"{Colors.WHITE}3.{Colors.END} ðŸ” Search logs")
        print(f"{Colors.WHITE}4.{Colors.END} â¬…ï¸  Back to menu")
        
        choice = input(f"\n{Colors.GREEN}Select option (1-4): {Colors.END}").strip()
        
        try:
            if choice == "1":
                self.print_colored("\nðŸ“„ Last 50 lines:", Colors.BLUE, True)
                result = subprocess.run(['tail', '-50', log_file], capture_output=True, text=True)
                print(result.stdout)
                
            elif choice == "2":
                self.print_colored("â¯ï¸  Following logs (Press Ctrl+C to stop):", Colors.BLUE, True)
                try:
                    subprocess.run(['tail', '-f', log_file])
                except KeyboardInterrupt:
                    self.print_colored("\nâœ… Stopped following logs", Colors.GREEN)
                    
            elif choice == "3":
                search_term = input(f"{Colors.GREEN}Enter search term: {Colors.END}").strip()
                if search_term:
                    self.print_colored(f"\nðŸ” Searching for '{search_term}':", Colors.BLUE, True)
                    result = subprocess.run(['grep', '-n', search_term, log_file], capture_output=True, text=True)
                    if result.stdout:
                        print(result.stdout)
                    else:
                        self.print_colored("No matches found", Colors.YELLOW)
                        
        except Exception as e:
            self.print_colored(f"âŒ Error viewing logs: {e}", Colors.RED)
            
    def test_health_detailed(self):
        """Test server health with detailed debugging"""
        self.print_colored("ðŸ§ª Detailed Health Check", Colors.CYAN, True)
        self.print_separator()
        
        # Step 1: Check if server process is running
        self.print_colored("1ï¸âƒ£ Checking server process...", Colors.BLUE, True)
        try:
            result = subprocess.run(['pgrep', '-f', 'kali_server.py'], capture_output=True, text=True)
            if result.returncode == 0:
                pids = result.stdout.strip().split('\n')
                self.print_colored(f"âœ… Server process running (PIDs: {', '.join(pids)})", Colors.GREEN)
            else:
                self.print_colored("âŒ Server process not found", Colors.RED)
                return
        except Exception as e:
            self.print_colored(f"âŒ Error checking process: {e}", Colors.RED)
            return
            
        # Step 2: Check port binding
        self.print_colored("\n2ï¸âƒ£ Checking port 5000...", Colors.BLUE, True)
        try:
            result = subprocess.run(['netstat', '-tlnp'], capture_output=True, text=True)
            if ':5000' in result.stdout:
                self.print_colored("âœ… Port 5000 is bound", Colors.GREEN)
            else:
                self.print_colored("âŒ Port 5000 not bound", Colors.RED)
        except Exception as e:
            self.print_colored(f"âŒ Error checking port: {e}", Colors.RED)
            
        # Step 3: Test basic connectivity
        self.print_colored("\n3ï¸âƒ£ Testing basic connectivity...", Colors.BLUE, True)
        try:
            response = requests.get("http://localhost:5000/health", timeout=5)
            self.print_colored(f"âœ… Server responding with status: {response.status_code}", Colors.GREEN)
            
            if response.status_code == 403:
                self.print_colored("â„¹ï¸  403 Forbidden - Server requires enrollment", Colors.YELLOW)
            elif response.status_code == 401:
                self.print_colored("â„¹ï¸  401 Unauthorized - Missing API key", Colors.YELLOW)
                
        except requests.exceptions.ConnectionError:
            self.print_colored("âŒ Connection refused - server not responding", Colors.RED)
            return
        except requests.exceptions.Timeout:
            self.print_colored("âŒ Request timeout - server too slow", Colors.RED)
            return
        except Exception as e:
            self.print_colored(f"âŒ Request failed: {e}", Colors.RED)
            return
            
        # Step 4: Check enrollment status
        self.print_colored("\n4ï¸âƒ£ Checking enrollment status...", Colors.BLUE, True)
        enrollment = self.get_enrollment_info()
        credentials = self.get_server_credentials()
        
        if not enrollment:
            self.print_colored("âŒ No enrollment token found", Colors.RED)
            self.print_colored("ðŸ’¡ Generate new token in Enrollment Manager", Colors.YELLOW)
            return
        else:
            self.print_colored(f"âœ… Enrollment token exists (ID: {enrollment['id']})", Colors.GREEN)
            
        if not credentials:
            self.print_colored("âŒ Server not enrolled with API", Colors.RED)
            self.print_colored("ðŸ’¡ Use Enrollment Manager to enroll server", Colors.YELLOW)
            return
        else:
            self.print_colored("âœ… Server is enrolled", Colors.GREEN)
            
        # Step 5: Test authenticated health check
        self.print_colored("\n5ï¸âƒ£ Testing authenticated health check...", Colors.BLUE, True)
        health = self.check_server_health(credentials.get('api_key'))
        
        if health:
            self.print_colored("âœ… Authenticated health check successful!", Colors.GREEN, True)
            self.print_colored(f"Server ID: {health.get('server_id', 'Unknown')}", Colors.WHITE)
            self.print_colored(f"Capabilities: {health.get('caps', {})}", Colors.WHITE)
            self.print_colored(f"Server Time: {health.get('time', 'Unknown')}", Colors.WHITE)
            
            if health.get('ngrok_tunnel'):
                tunnel_info = health['ngrok_tunnel']
                self.print_colored(f"ðŸŒ Ngrok Status: {tunnel_info.get('status', 'unknown')}", Colors.CYAN)
                if tunnel_info.get('public_url'):
                    self.print_colored(f"ðŸ”— Public URL: {tunnel_info['public_url']}", Colors.CYAN)
                if tunnel_info.get('error'):
                    self.print_colored(f"âŒ Ngrok Error: {tunnel_info['error']}", Colors.RED)
        else:
            self.print_colored("âŒ Authenticated health check failed", Colors.RED, True)
            self.print_colored("ðŸ’¡ Check API key or server enrollment", Colors.YELLOW)
            
        self.print_separator()
    
    def enrollment_manager(self):
        """Manage server enrollment"""
        while True:
            self.print_colored("\nðŸ”‘ Enrollment Manager", Colors.CYAN, True)
            self.print_separator()
            
            enrollment = self.get_enrollment_info()
            credentials = self.get_server_credentials()
            
            # Show current status
            if enrollment:
                self.print_colored(f"ðŸ“‹ Current Token:", Colors.GREEN, True)
                self.print_colored(f"   ID: {enrollment['id']}", Colors.WHITE)
                self.print_colored(f"   Created: {enrollment['created']}", Colors.WHITE)
                
            if credentials:
                self.print_colored(f"\nâœ… Enrollment Status: ENROLLED", Colors.GREEN, True)
                self.print_colored(f"   Label: {credentials['label']}", Colors.WHITE)
                self.print_colored(f"   API Key: {credentials['api_key'][:20]}...", Colors.WHITE)
            else:
                self.print_colored(f"\nâŒ Enrollment Status: NOT ENROLLED", Colors.RED, True)
                
            # Show menu
            print(f"\n{Colors.WHITE}1.{Colors.END} ðŸ”„ Generate New Token")
            print(f"{Colors.WHITE}2.{Colors.END} ðŸ“ Enroll Server")
            print(f"{Colors.WHITE}3.{Colors.END} ðŸ—‘ï¸  Delete Enrollment")
            print(f"{Colors.WHITE}4.{Colors.END} ðŸ“‹ Show Enrollment Command")
            print(f"{Colors.WHITE}5.{Colors.END} â¬…ï¸  Back to Main Menu")
            
            choice = input(f"\n{Colors.GREEN}Select option (1-5): {Colors.END}").strip()
            
            if choice == "1":
                self.generate_new_enrollment_token()
            elif choice == "2":
                self.enroll_server()
            elif choice == "3":
                self.delete_enrollment()
            elif choice == "4":
                self.show_enrollment_command()
            elif choice == "5":
                break
            else:
                self.print_colored("âŒ Invalid choice. Please select 1-5.", Colors.RED)
                
    def generate_new_enrollment_token(self):
        """Generate a new enrollment token"""
        self.print_colored("ðŸ”„ Generating new enrollment token...", Colors.CYAN, True)
        
        try:
            import secrets
            import socket
            from datetime import datetime
            
            # Generate new token
            server_id = f'kali-{socket.gethostname()}-{int(datetime.now().timestamp())}'
            token = secrets.token_urlsafe(32)
            
            enrollment_data = {
                'id': server_id,
                'token': token,
                'created': datetime.now().isoformat()
            }
            
            # Ensure directory exists
            os.makedirs(self.config_dir, exist_ok=True)
            
            # Save enrollment token
            enroll_file = f"{self.config_dir}/enroll.json"
            with open(enroll_file, 'w') as f:
                json.dump(enrollment_data, f, indent=2)
                
            # Set proper permissions
            os.chmod(enroll_file, 0o600)
            
            self.print_colored("âœ… New enrollment token generated!", Colors.GREEN, True)
            self.print_colored(f"Server ID: {server_id}", Colors.WHITE)
            self.print_colored(f"Token: {token[:20]}...", Colors.WHITE)
            
        except Exception as e:
            self.print_colored(f"âŒ Failed to generate token: {e}", Colors.RED, True)
            
    def enroll_server(self):
        """Enroll the server with the API"""
        enrollment = self.get_enrollment_info()
        if not enrollment:
            self.print_colored("âŒ No enrollment token found. Generate one first.", Colors.RED)
            return
            
        self.print_colored("ðŸ“ Enrolling server...", Colors.CYAN, True)
        
        # Get label from user
        label = input(f"{Colors.GREEN}Enter server label (default: Kali-Lab): {Colors.END}").strip()
        if not label:
            label = "Kali-Lab"
            
        try:
            # Make enrollment request
            payload = {
                'id': enrollment['id'],
                'token': enrollment['token'],
                'label': label
            }
            
            self.print_colored(f"Enrolling with ID: {enrollment['id']}", Colors.BLUE)
            
            response = requests.post(
                "http://localhost:5000/enroll",
                json=payload,
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                creds_data = response.json()
                
                # Save credentials
                creds_file = f"{self.config_dir}/credentials.json"
                with open(creds_file, 'w') as f:
                    json.dump(creds_data, f, indent=2)
                    
                os.chmod(creds_file, 0o600)
                
                self.print_colored("âœ… Server enrolled successfully!", Colors.GREEN, True)
                self.print_colored(f"Server ID: {creds_data['server_id']}", Colors.WHITE)
                self.print_colored(f"Label: {creds_data['label']}", Colors.WHITE)
                self.print_colored(f"API Key: {creds_data['api_key'][:20]}...", Colors.WHITE)
                
            else:
                self.print_colored(f"âŒ Enrollment failed: HTTP {response.status_code}", Colors.RED, True)
                try:
                    error_data = response.json()
                    self.print_colored(f"Error: {error_data.get('detail', 'Unknown error')}", Colors.RED)
                except:
                    self.print_colored(f"Response: {response.text}", Colors.RED)
                    
        except requests.exceptions.ConnectionError:
            self.print_colored("âŒ Cannot connect to server. Is it running?", Colors.RED, True)
        except Exception as e:
            self.print_colored(f"âŒ Enrollment failed: {e}", Colors.RED, True)
            
    def delete_enrollment(self):
        """Delete enrollment data"""
        confirm = input(f"{Colors.YELLOW}Delete all enrollment data? This will require re-enrollment. (y/N): {Colors.END}").strip().lower()
        
        if confirm in ['y', 'yes']:
            try:
                enroll_file = f"{self.config_dir}/enroll.json"
                creds_file = f"{self.config_dir}/credentials.json"
                
                if Path(enroll_file).exists():
                    os.remove(enroll_file)
                    self.print_colored("ðŸ—‘ï¸  Enrollment token deleted", Colors.YELLOW)
                    
                if Path(creds_file).exists():
                    os.remove(creds_file)
                    self.print_colored("ðŸ—‘ï¸  Credentials deleted", Colors.YELLOW)
                    
                self.print_colored("âœ… Enrollment data cleared", Colors.GREEN)
                
            except Exception as e:
                self.print_colored(f"âŒ Failed to delete: {e}", Colors.RED)
        else:
            self.print_colored("â„¹ï¸  Deletion cancelled", Colors.BLUE)
            
    def show_enrollment_command(self):
        """Show the enrollment command"""
        enrollment = self.get_enrollment_info()
        if not enrollment:
            self.print_colored("âŒ No enrollment token found. Generate one first.", Colors.RED)
            return
            
        self.print_colored("ðŸ“‹ Enrollment Command:", Colors.CYAN, True)
        self.print_separator()
        
        cmd = f"""curl -X POST http://localhost:5000/enroll \\
  -H "Content-Type: application/json" \\
  -d '{{"id":"{enrollment['id']}","token":"{enrollment['token']}","label":"Kali-Lab"}}'"""
        
        self.print_colored(cmd, Colors.WHITE)
        self.print_separator()
        
    def check_ngrok_status(self):
        """Check ngrok tunnel status"""
        self.print_colored("ðŸŒ Ngrok Tunnel Status", Colors.CYAN, True)
        self.print_separator()
        
        # Check if ngrok process is running
        try:
            result = subprocess.run(['pgrep', '-f', 'ngrok'], capture_output=True, text=True)
            if result.returncode == 0:
                self.print_colored("âœ… Ngrok process is running", Colors.GREEN)
            else:
                self.print_colored("âŒ Ngrok process not found", Colors.RED)
        except:
            self.print_colored("âŒ Could not check ngrok process", Colors.RED)
            
        # Check server health for ngrok info
        credentials = self.get_server_credentials()
        if credentials:
            health = self.check_server_health(credentials.get('api_key'))
            if health and health.get('ngrok_tunnel'):
                tunnel_info = health['ngrok_tunnel']
                
                self.print_colored(f"\nðŸ“Š Tunnel Information:", Colors.BLUE, True)
                self.print_colored(f"Status: {tunnel_info.get('status', 'unknown')}", Colors.WHITE)
                
                if tunnel_info.get('public_url'):
                    self.print_colored(f"Public URL: {tunnel_info['public_url']}", Colors.GREEN)
                    
                if tunnel_info.get('config'):
                    config = tunnel_info['config']
                    self.print_colored(f"Local Address: {config.get('addr', 'unknown')}", Colors.WHITE)
                    self.print_colored(f"Protocol: {config.get('proto', 'unknown')}", Colors.WHITE)
                    if config.get('domain'):
                        self.print_colored(f"Custom Domain: {config['domain']}", Colors.WHITE)
                        
                if tunnel_info.get('error'):
                    self.print_colored(f"\nâŒ Ngrok Error: {tunnel_info['error']}", Colors.RED, True)
                    
                    # Common ngrok errors and solutions
                    error_msg = tunnel_info['error'].lower()
                    if 'invalid authtoken' in error_msg:
                        self.print_colored("ðŸ’¡ Solution: Check your ngrok auth token", Colors.YELLOW)
                        self.print_colored("   Get token from: https://dashboard.ngrok.com/get-started/your-authtoken", Colors.YELLOW)
                    elif 'domain not found' in error_msg:
                        self.print_colored("ðŸ’¡ Solution: Check custom domain or remove it", Colors.YELLOW)
                    elif 'account limit' in error_msg:
                        self.print_colored("ðŸ’¡ Solution: Upgrade ngrok plan or stop other tunnels", Colors.YELLOW)
                        
            else:
                self.print_colored("â„¹ï¸  No ngrok tunnel information available", Colors.YELLOW)
        else:
            self.print_colored("âŒ Cannot check tunnel status - server not enrolled", Colors.RED)
            
        self.print_separator()
            
    def view_artifacts(self):
        """View artifacts directory"""
        artifacts_dir = "/var/lib/mcp/artifacts"
        if Path(artifacts_dir).exists():
            try:
                result = subprocess.run(['ls', '-la', artifacts_dir], capture_output=True, text=True)
                self.print_colored("ðŸ“ Artifacts directory:", Colors.CYAN, True)
                self.print_colored(result.stdout, Colors.WHITE)
            except:
                self.print_colored("âŒ Failed to list artifacts", Colors.RED)
        else:
            self.print_colored("ðŸ“ No artifacts directory found", Colors.YELLOW)
            
    def stop_server(self):
        """Stop the server process"""
        if self.server_process:
            self.print_colored("ðŸ›‘ Stopping server...", Colors.YELLOW, True)
            try:
                self.server_process.terminate()
                self.server_process.wait(timeout=10)
                self.print_colored("âœ… Server stopped successfully", Colors.GREEN)
            except subprocess.TimeoutExpired:
                self.print_colored("âš ï¸  Force killing server...", Colors.YELLOW)
                self.server_process.kill()
                self.server_process.wait()
                self.print_colored("âœ… Server force stopped", Colors.GREEN)
            except:
                pass
            self.server_process = None
        else:
            self.print_colored("â„¹ï¸  Server is not running", Colors.BLUE)
            
    def setup_signal_handlers(self):
        """Setup signal handlers for graceful shutdown"""
        def signal_handler(signum, frame):
            self.print_colored(f"\nðŸ›‘ Received signal {signum}, shutting down...", Colors.YELLOW, True)
            self.stop_server()
            sys.exit(0)
            
        signal.signal(signal.SIGINT, signal_handler)
        signal.signal(signal.SIGTERM, signal_handler)
        
    def run(self):
        """Main entry point"""
        self.setup_signal_handlers()
        self.check_root()
        self.check_installation()
        
        self.print_banner()
        
        # Get ngrok configuration
        ngrok_token, ngrok_domain = self.prompt_ngrok_token()
        
        # Start server
        if self.start_server_process(ngrok_token, ngrok_domain):
            time.sleep(2)  # Give server time to fully start
            self.display_server_info()
            self.show_menu()
        else:
            self.print_colored("âŒ Automatic server startup failed.", Colors.RED, True)
            self.print_separator()
            self.print_colored("ðŸ› ï¸ Manual Startup Options", Colors.CYAN, True)
            
            cmd_base = f"{self.venv_python} {self.server_script} --bind 0.0.0.0:5000"
            
            if ngrok_token:
                cmd_ngrok = f"{cmd_base} --ngrok --ngrok-authtoken {ngrok_token}"
                if ngrok_domain:
                    cmd_ngrok += f" --ngrok-domain {ngrok_domain}"
                
                self.print_colored("\nðŸŒ With ngrok tunnel:", Colors.GREEN)
                self.print_colored(f"nohup {cmd_ngrok} > /var/log/mcp-kali-server.log 2>&1 &", Colors.WHITE)
            else:
                self.print_colored("\nðŸ”— Local server:", Colors.GREEN)
                self.print_colored(f"nohup {cmd_base} > /var/log/mcp-kali-server.log 2>&1 &", Colors.WHITE)
            
            self.print_colored("\nðŸ“‹ Check logs:", Colors.BLUE)
            self.print_colored("tail -f /var/log/mcp-kali-server.log", Colors.WHITE)
            
            self.print_colored("\nðŸ§ª Test connection:", Colors.BLUE)
            self.print_colored("curl -sS http://localhost:5000/health", Colors.WHITE)
            
            self.print_separator()
            
            # Ask if user wants to try manual startup
            try:
                choice = input(f"\n{Colors.GREEN}Try manual startup now? (y/N): {Colors.END}").strip().lower()
                if choice in ['y', 'yes']:
                    self.print_colored("ðŸš€ Starting server manually...", Colors.CYAN, True)
                    
                    # Try manual startup
                    if ngrok_token:
                        cmd = f"nohup {cmd_ngrok} > /var/log/mcp-kali-server.log 2>&1 &"
                    else:
                        cmd = f"nohup {cmd_base} > /var/log/mcp-kali-server.log 2>&1 &"
                    
                    os.system(cmd)
                    time.sleep(3)
                    
                    # Check if it worked
                    try:
                        response = requests.get("http://localhost:5000/health", timeout=5)
                        if response.status_code in [200, 401]:
                            self.print_colored("âœ… Manual startup successful!", Colors.GREEN, True)
                            self.display_server_info()
                        else:
                            self.print_colored("âš ï¸ Server may be starting... check logs", Colors.YELLOW)
                    except:
                        self.print_colored("âš ï¸ Server starting in background... check logs", Colors.YELLOW)
                        
            except KeyboardInterrupt:
                pass
                
            self.print_colored("\nðŸ‘‹ Exiting CLI. Server may be running in background.", Colors.CYAN)

def main():
    """Main function"""
    if len(sys.argv) > 1 and sys.argv[1] == "start-server":
        cli = DarkMaterCLI()
        cli.run()
    else:
        print("Usage: dark-mater_kali-mcp start-server")
        sys.exit(1)

if __name__ == "__main__":
    main()